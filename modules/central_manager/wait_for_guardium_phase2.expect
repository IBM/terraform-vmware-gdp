#!/usr/bin/expect -f

set timeout 300

# Inputs: IP, Password, Shared Secret
set IP [lindex $argv 0]
set PASSWORD [lindex $argv 1]
set SHARED_SECRET [lindex $argv 2]

puts "\nğŸ“¥ Starting Guardium Phase 2 Configuration"
puts "   ğŸ”¹ IP: $IP"
puts "   ğŸ”¹ PASSWORD: [string repeat * [string length $PASSWORD]]"
puts "   ğŸ”¹ SHARED_SECRET: $SHARED_SECRET"
puts "-------------------------------------------"

# Remove any old SSH host key entry before connecting
puts "ğŸ§¹ Cleaning up old SSH key for $IP..."
catch {exec sh -c "ssh-keygen -R $IP > /dev/null 2>&1"} result

# SSH connection
puts "ğŸ” Connecting to cli@$IP..."
if {[catch {spawn ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null cli@$IP} err]} {
    puts "âŒ Failed to spawn SSH session: $err"
    exit 1
}

# Login
expect {
    "password:" {
        puts "ğŸ”‘ Sending password..."
        send "$PASSWORD\r"
    }
    timeout {
        puts "âŒ Timeout waiting for password prompt."
        exit 1
    }
    eof {
        puts "âŒ SSH connection closed unexpectedly during login."
        exit 1
    }
}

# Wait for CLI prompt
expect {
    -re {[\r\n]+.*?>\s*} {
        puts "âœ… Connected to Guardium CLI"
    }
    timeout {
        puts "âŒ Timeout waiting for CLI prompt after login."
        exit 1
    }
    eof {
        puts "âŒ Connection closed unexpectedly after login."
        exit 1
    }
}

# Wait a moment for system to be ready
sleep 5

# Verify license is accepted by checking unit type
puts "ğŸ” Checking current unit type..."
send "show unit type\r"
expect {
    -re {(.*)\r\n.*>} {
        set output $expect_out(1,string)
        puts "ğŸ“‹ Current unit type: $output"
    }
    timeout {
        puts "âš ï¸  Timeout during 'show unit type'. Continuing..."
    }
    eof {
        puts "âŒ Connection closed unexpectedly."
        exit 1
    }
}

# Set unit type to manager (if not already set)
puts "âš™ï¸  Setting unit type to manager..."
send "store unit type manager\r"
expect {
    -re {.*>} {
        puts "âœ… Unit type set to manager"
    }
    "Invalid command" {
        puts "âš ï¸  'store unit type manager' command not available (may already be set)"
    }
    timeout {
        puts "âš ï¸  Timeout setting unit type. Continuing..."
    }
    eof {
        puts "âŒ Connection closed unexpectedly."
        exit 1
    }
}

# Set shared secret (in case it wasn't set in Phase 1)
if {$SHARED_SECRET != ""} {
    puts "ğŸ” Setting shared secret..."
    send "store system shared secret $SHARED_SECRET\r"
    expect {
        -re {.*>} {
            puts "âœ… Shared secret configured"
        }
        timeout {
            puts "âš ï¸  Timeout setting shared secret."
        }
        eof {
            puts "âŒ Connection closed unexpectedly."
            exit 1
        }
    }
}

# Verify network configuration
puts "ğŸŒ Verifying network configuration..."
send "show network verify\r"
expect {
    -re {(.*)\r\n.*>} {
        set output $expect_out(1,string)
        puts "ğŸ“‹ Network verification: $output"
    }
    timeout {
        puts "âš ï¸  Timeout during network verification."
    }
    eof {
        puts "âŒ Connection closed unexpectedly."
        exit 1
    }
}

# Show license status
puts "ğŸ“œ Checking license status..."
send "show license\r"
expect {
    -re {(.*)\r\n.*>} {
        set output $expect_out(1,string)
        puts "ğŸ“‹ License status: $output"
    }
    timeout {
        puts "âš ï¸  Timeout checking license."
    }
    eof {
        puts "âŒ Connection closed unexpectedly."
        exit 1
    }
}
send "quit\r"
expect eof

puts "\nâœ… Phase 2 configuration completed successfully!"
exit 0
