#!/usr/bin/expect -f

set timeout 600

# Inputs: IP, Password, Shared Secret, Guardium CM IP
set IP [lindex $argv 0]
set PASSWORD [lindex $argv 1]
set SHARED_SECRET [lindex $argv 2]
set GUARDIUM_CM_IP [lindex $argv 3]

puts "\nğŸ“¥ Starting manual_shared_secret_setup.expect"
puts "   ğŸ”¹ IP: $IP"
puts "   ğŸ”¹ PASSWORD: [string repeat * [string length $PASSWORD]]"
puts "   ğŸ”¹ SHARED_SECRET: $SHARED_SECRET"
puts "   ğŸ”¹ GUARDIUM_CM_IP: $GUARDIUM_CM_IP"
puts "-------------------------------------------"

# Remove any old SSH host key entry before connecting
puts "ğŸ§¹ Cleaning up old SSH key for $IP..."
catch {exec sh -c "ssh-keygen -R $IP > /dev/null 2>&1"} result

# SSH connection
puts "ğŸ” Connecting to cli@$IP..."
if {[catch {spawn ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null cli@$IP} err]} {
    puts "âŒ Failed to spawn SSH session: $err"
    exit 1
}

# Login
expect {
    "password:" {
        puts "ğŸ”‘ Sending password..."
        send "$PASSWORD\r"
    }
    timeout {
        puts "âŒ Timeout waiting for password prompt."
        exit 1
    }
    eof {
        puts "âŒ SSH connection closed unexpectedly during login."
        exit 1
    }
}

# Wait for CLI prompt
expect {
    -re {[\r\n]+.*?>\s*} {}
    timeout {
        puts "âŒ Timeout waiting for CLI prompt after login."
        exit 1
    }
    eof {
        puts "âŒ Connection closed unexpectedly after login."
        exit 1
    }
}

# Verify network configuration before proceeding
puts "ğŸŒ Verifying network configuration..."
send "show network verify\r"
expect {
    -re {(.*)\r\n.*>} {
        set output $expect_out(1,string)
        puts "ğŸ“‹ Network verification: $output"
    }
    timeout {
        puts "âš ï¸  Timeout during network verification."
    }
    eof {
        puts "âŒ Connection closed unexpectedly."
        exit 1
    }
}

# Store the shared secret
puts "ğŸ” Storing shared secret..."
sleep 30
send "store system shared secret $SHARED_SECRET\r"
expect {
    -re {.*>} {}
    "Invalid command" {
        puts "âŒ Failed: 'store system shared secret' is not valid."
        exit 1
    }
    timeout {
        puts "âŒ Timeout while storing shared secret."
        exit 1
    }
    eof {
        puts "âŒ Connection closed unexpectedly after storing shared secret."
        exit 1
    }
}

# Register to Guardium CM
puts "ğŸ“¡ Registering to Central Manager at $GUARDIUM_CM_IP..."
sleep 60
send "register management $GUARDIUM_CM_IP 8443\r"
expect {
    "Could not register with the manager unit at this time" {
        puts "âŒ ERROR: Registration failed with manager $GUARDIUM_CM_IP"
        exit 1
    }
    -re {Successfully registered.*} {
        puts "âœ… Registration succeeded"
        expect {
            eof {
                puts "ğŸ‘‹ CLI session closed by Guardium after successful registration."
                exit 0
            }
            timeout {
                puts "âŒ Timeout after registration success message."
                exit 1
            }
        }
    }
    -re {.*>} {
        puts "âœ… Registration completed (prompt returned)"
        sleep 30
        # Verify network configuration after registration
        puts "ğŸŒ Verifying network configuration..."
        send "show network verify\r"
        expect {
            -re {(.*)\r\n.*>} {
                set output $expect_out(1,string)
                puts "ğŸ“‹ Network verification: $output"
            }
            timeout {
                puts "âš ï¸  Timeout during network verification."
            }
            eof {
                puts "âŒ Connection closed unexpectedly."
                exit 1
            }
        }
        
        send "quit\r"
        expect eof
        exit 0
    }
    timeout {
        puts "âŒ Timeout waiting for registration response."
        exit 1
    }
    eof {
        puts "âš ï¸ Connection closed unexpectedly after registration (no success message)."
        exit 1
    }
}
